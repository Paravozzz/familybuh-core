<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                   https://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd">

    <property name="now" value="sysdate" dbms="oracle"/>
    <property name="now" value="now()" dbms="mysql"/>
    <property name="now" value="now()" dbms="postgresql"/>

    <changeSet id="001" author="admin" labels="schema">
        <preConditions onFail="HALT">
            <not>
                <tableExists tableName="currency"/>
            </not>
            <not>
                <tableExists tableName="family"/>
            </not>
            <not>
                <tableExists tableName="user_info"/>
            </not>
            <not>
                <tableExists tableName="user_info_currency"/>
            </not>
            <not>
                <tableExists tableName="account"/>
            </not>
            <not>
                <tableExists tableName="category"/>
            </not>
            <not>
                <tableExists tableName="operation"/>
            </not>
        <not>
                <tableExists tableName="setting"/>
            </not>
        </preConditions>
        <createTable tableName="currency">
            <column name="id" type="varchar(3)">
                <constraints primaryKey="true" nullable="false" primaryKeyName="pk_currency"/>
            </column>
            <column name="code" type="varchar(3)">
                <constraints unique="true" nullable="false"/>
            </column>
            <column name="name" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <createTable tableName="family">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" primaryKeyName="pk_family"/>
            </column>
        </createTable>

        <createTable tableName="user_info">
            <column name="id" type="varchar(36)" autoIncrement="false">
                <constraints primaryKey="true" nullable="false" primaryKeyName="pk_user_info"/>
            </column>
            <column name="family_id" type="bigint" autoIncrement="false">
                <constraints foreignKeyName="fk_family" referencedTableName="family" referencedColumnNames="id"
                             nullable="true"/>
            </column>
        </createTable>

        <createTable tableName="user_info_currency">
            <column name="user_info_id" type="varchar(36)" autoIncrement="false">
                <constraints nullable="false" foreignKeyName="fk_user_info" referencedTableName="user_info"
                             referencedColumnNames="id"/>
            </column>
            <column name="currency_id" type="varchar(3)" autoIncrement="false">
                <constraints nullable="false" foreignKeyName="fk_currency" referencedTableName="currency"
                             referencedColumnNames="id"/>
            </column>
        </createTable>

        <addPrimaryKey tableName="user_info_currency" columnNames="user_info_id, currency_id" constraintName="pk_user_info_currency"/>

        <createTable tableName="account">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" primaryKeyName="pk_account"/>
            </column>
            <column name="name" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="varchar(255)">
                <constraints nullable="true"/>
            </column>
            <column name="initial_balance" type="numeric(38, 2)" defaultValueNumeric="0"/>
            <column name="currency_id" type="varchar(3)">
                <constraints nullable="false" foreignKeyName="fk_account_currency" referencedTableName="currency"
                             referencedColumnNames="id"/>
            </column>
            <column name="user_info_id" type="varchar(36)">
                <constraints nullable="false" foreignKeyName="fk_account_user_info" referencedTableName="user_info"
                             referencedColumnNames="id"/>
            </column>
        </createTable>

        <addUniqueConstraint tableName="account" columnNames="name, currency_id, user_info_id"/>

        <createTable tableName="category">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" primaryKeyName="pk_category"/>
            </column>
            <column name="name" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="is_income" type="bool" defaultOnNull="true" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <createTable tableName="operation">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" primaryKeyName="pk_operation"/>
            </column>
            <column name="amount" type="numeric(38, 2)">
                <constraints nullable="false"/>
            </column>
            <column name="account_id" type="bigint">
                <constraints nullable="false" foreignKeyName="fk_operation_account" referencedTableName="account"
                             referencedColumnNames="id" deleteCascade="false"/>
            </column>
            <column name="operation_type" type="integer">
                <constraints nullable="false"/>
            </column>
            <column name="category_id" type="bigint">
                <constraints nullable="false" foreignKeyName="fk_operation_category" referencedTableName="category"
                             referencedColumnNames="id" deleteCascade="false"/>
            </column>
            <column name="pair_id" type="uuid"/>
            <column name="description" type="varchar(255)">
                <constraints nullable="true"/>
            </column>
            <column name="date" type="timestamptz" defaultOnNull="true" defaultValueComputed="${now}">
                <constraints nullable="false"/>
            </column>
            <column name="user_info_id" type="varchar(36)">
                <constraints nullable="false" foreignKeyName="fk_operation_user_info" referencedTableName="user_info"
                             referencedColumnNames="id"/>
            </column>
        </createTable>

        <createTable tableName="user_info_category">
            <column name="user_info_id" type="varchar(36)" autoIncrement="false">
                <constraints nullable="false" foreignKeyName="fk_user_info" referencedTableName="user_info"
                             referencedColumnNames="id"/>
            </column>
            <column name="category_id" type="bigint" autoIncrement="false">
                <constraints nullable="false" foreignKeyName="fk_category" referencedTableName="category"
                             referencedColumnNames="id"/>
            </column>
        </createTable>

        <addPrimaryKey tableName="user_info_category" columnNames="user_info_id, category_id" constraintName="pk_user_info_category"/>

        <createTable tableName="setting">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" primaryKeyName="pk_setting"/>
            </column>
            <column name="name" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="value" type="varchar(255)">
                <constraints nullable="true"/>
            </column>
        </createTable>

        <createTable tableName="user_info_setting">
            <column name="user_info_id" type="varchar(36)" autoIncrement="false">
                <constraints nullable="false" foreignKeyName="fk_user_info" referencedTableName="user_info"
                             referencedColumnNames="id"/>
            </column>
            <column name="setting_id" type="bigint" autoIncrement="false">
                <constraints nullable="false" foreignKeyName="fk_setting" referencedTableName="setting"
                             referencedColumnNames="id"/>
            </column>
        </createTable>

        <addPrimaryKey tableName="user_info_setting" columnNames="user_info_id, setting_id" constraintName="pk_user_info_setting"/>



    </changeSet>
</databaseChangeLog>